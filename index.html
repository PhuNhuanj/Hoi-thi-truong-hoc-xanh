<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªôi Thi Tr∆∞·ªùng H·ªçc Xanh - Ph√∫ Nhu·∫≠n 2025 (Tournament Edition)</title>
    <style>
        :root {
            --primary: #0d6efd;
            --success: #198754;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #0dcaf0;
            --dark: #212529;
            --light: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            /* ƒê·∫£m b·∫£o file ·∫£nh background_hoithi.jpg n·∫±m c√πng th∆∞ m·ª•c */
            background-image: url('background_hoithi.jpg'); 
            background-size: cover;
            background-position: center bottom;
            background-repeat: no-repeat;
            background-attachment: fixed;
            
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* --- UI CHUNG --- */
        .full-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(8px); 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: var(--dark);
            transition: opacity 0.3s;
        }

        .input-group {
            margin: 20px 0;
            text-align: center;
        }

        input[type="text"] {
            padding: 15px;
            font-size: 1.5rem;
            border-radius: 10px;
            border: 2px solid var(--primary);
            width: 300px;
            text-align: center;
            margin-bottom: 20px;
            background: white;
            color: var(--dark);
            font-weight: bold;
        }

        .btn-large {
            padding: 15px 40px;
            font-size: 1.5rem;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            background: linear-gradient(45deg, var(--warning), #ffdb58);
            color: var(--dark);
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.4);
        }
        .btn-large:hover { transform: scale(1.05); box-shadow: 0 8px 25px rgba(255, 193, 7, 0.6); }

        .btn-success {
            background: linear-gradient(45deg, var(--success), #28a745);
            color: white;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        /* --- B·∫¢NG X·∫æP H·∫†NG --- */
        .leaderboard-box {
            background: rgba(255, 255, 255, 0.95);
            color: black;
            padding: 20px;
            border-radius: 15px;
            width: 80%;
            max-width: 800px;
            max-height: 60vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 2px solid var(--primary);
        }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #ddd; font-size: 1.2rem; }
        th { background: var(--primary); color: white; position: sticky; top: 0; }
        tr:nth-child(1) td { font-weight: bold; color: #d63384; font-size: 1.3rem; background-color: #fff0f5;} 
        
        /* --- GAME HEADER --- */
        header {
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            z-index: 100;
            height: 70px;
            border-bottom: 3px solid var(--success);
        }

        .team-name { font-size: 1.5rem; font-weight: bold; color: var(--primary); text-transform: uppercase; }
        
        .hud { display: flex; gap: 20px; font-size: 1.4rem; font-weight: bold; }
        .timer-box { color: var(--danger); background: #fff5f5; padding: 5px 15px; border-radius: 8px; border: 2px solid var(--danger); }

        #btn-submit {
            background: linear-gradient(45deg, var(--danger), #ff6b6b);
            color: white; border: none; padding: 10px 25px; font-size: 1.2rem;
            border-radius: 30px; cursor: pointer; font-weight: bold;
            box-shadow: 0 4px 10px rgba(220, 53, 69, 0.4); transition: all 0.2s;
        }
        #btn-submit:hover { transform: scale(1.05); }
        #btn-submit:disabled { background: #ccc; cursor: default; box-shadow: none; transform: none;}

        /* --- GAME AREA --- */
        #game-container { display: flex; flex: 1; flex-direction: column; position: relative; }
        #play-area {
            flex: 1; position: relative;
            background-color: rgba(255, 255, 255, 0.7); 
            border-bottom: 3px solid #ccc;
        }

        .trash-card {
            width: 100px; height: 100px; /* Thu nh·ªè x√≠u ƒë·ªÉ ch·ª©a ƒë·ªß 20 m√≥n */
            position: absolute;
            background: white; border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: grab; transition: transform 0.2s; z-index: 50;
            border: 3px solid white; padding: 2px;
        }
        .trash-card:active { cursor: grabbing; transform: scale(1.1); z-index: 100; border-color: var(--warning); }
        .trash-img { width: 55px; height: 55px; object-fit: contain; margin-bottom: 2px; }
        .trash-label { font-size: 0.8rem; font-weight: bold; text-align: center; line-height: 1.1; color: #495057; }

        /* --- BINS --- */
        #bins-area {
            height: 250px; display: flex; justify-content: space-evenly; align-items: flex-end;
            padding: 10px; background: rgba(255, 255, 255, 0.85); box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
        }
        .bin-zone { width: 30%; height: 100%; display: flex; flex-direction: column; position: relative; }
        .bin-storage {
            flex: 1; background: rgba(255,255,255,0.6);
            border: 4px dashed #adb5bd; border-radius: 15px 15px 0 0;
            margin-bottom: 0; padding: 5px; display: flex; flex-wrap: wrap;
            align-content: flex-start; justify-content: center; overflow-y: auto; transition: all 0.3s;
        }
        .bin-storage.drag-over { background: rgba(255, 235, 59, 0.5); border-color: var(--warning); transform: scale(1.02); }
        .bin-header {
            height: 50px; display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; font-size: 1.3rem; text-transform: uppercase;
            border-radius: 0 0 15px 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .trash-card.in-bin {
            position: static !important; width: 50px !important; height: 50px !important;
            margin: 2px; border: 2px solid #ddd; box-shadow: none;
        }
        .trash-card.in-bin .trash-img { width: 30px; height: 30px; margin-bottom: 0; }
        .trash-card.in-bin .trash-label { display: none; }

        .bg-organic { background: linear-gradient(to bottom, var(--success), #28a745); }
        .bg-recycle { background: linear-gradient(to bottom, var(--info), #0dcaf0); }
        .bg-other { background: linear-gradient(to bottom, var(--dark), #343a40); }

        /* --- RESULT SCREEN STYLES --- */
        #review-box {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            width: 100%;
            box-sizing: border-box;
        }
        .mistake-item {
            border-bottom: 1px solid #ddd;
            padding: 8px 0;
            font-size: 1rem;
        }
        .mistake-item:last-child { border-bottom: none; }
        .ans-wrong { color: var(--danger); font-weight: bold; text-decoration: line-through; }
        .ans-right { color: var(--success); font-weight: bold; }
        
        .hidden { display: none !important; }
        .btn-link { background: none; border: none; color: var(--primary); text-decoration: underline; cursor: pointer; margin-top: 15px; font-weight: bold; font-size: 1.1rem;}

        h1.main-title {
             color: var(--primary); text-transform: uppercase; font-size: 3.5rem; text-align: center;
             text-shadow: 2px 2px 0 #fff, -2px 2px 0 #fff, 2px -2px 0 #fff, -2px -2px 0 #fff, 0px 4px 10px rgba(0,0,0,0.3);
             margin-bottom: 10px;
        }
        h2.sub-title {
            color: var(--dark); font-weight: bold; background: rgba(255,255,255,0.8);
            padding: 5px 15px; border-radius: 20px;
        }
    </style>
</head>
<body>

    <div id="screen-register" class="full-screen">
        <h1 class="main-title">H·ªôi Thi Tr∆∞·ªùng H·ªçc Xanh</h1>
        <h2 class="sub-title">Ph·∫ßn thi: Th·ª±c h√†nh Ph√¢n lo·∫°i r√°c</h2>
        
        <div class="input-group" style="background: rgba(255,255,255,0.9); padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
            <p style="font-weight: bold; font-size: 1.2rem; color: var(--primary);">Nh·∫≠p t√™n ƒê∆°n v·ªã / Tr∆∞·ªùng h·ªçc:</p>
            <input type="text" id="inp-team-name" placeholder="V√≠ d·ª•: Ti·ªÉu h·ªçc A..." autocomplete="off">
            <br>
            <button class="btn-large" onclick="goToGame()">B·∫ÆT ƒê·∫¶U THI NGAY!</button>
        </div>
        
        <button class="btn-link" onclick="showLeaderboard()">Xem B·∫£ng X·∫øp H·∫°ng</button>
    </div>

    <div id="screen-leaderboard" class="full-screen hidden">
        <h2 style="color: var(--primary); text-shadow: 2px 2px 0px white; font-size: 3rem; margin-bottom: 20px;">üèÜ B·∫¢NG T·ªîNG S·∫ÆP üèÜ</h2>
        <div class="leaderboard-box">
            <table id="tbl-leaderboard">
                <thead>
                    <tr>
                        <th>H·∫°ng</th>
                        <th>ƒê∆°n v·ªã</th>
                        <th>ƒêi·ªÉm</th>
                        <th>Th·ªùi gian c√≤n l·∫°i</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div style="margin-top: 20px; background: rgba(255,255,255,0.8); padding: 15px; border-radius: 15px; display: flex; gap: 10px; justify-content: center; align-items: center;">
            <button class="btn-large" style="font-size: 1rem; padding: 10px 20px;" onclick="backToRegister()">Quay l·∫°i</button>
            <button class="btn-large btn-success" style="font-size: 1rem; padding: 10px 20px;" onclick="exportExcel()">‚¨á Xu·∫•t File Excel</button>
            <button class="btn-link" style="color: var(--danger); margin-left: 10px; margin-top:0;" onclick="clearData()">X√≥a d·ªØ li·ªáu</button>
        </div>
    </div>

    <div id="screen-game" class="hidden" style="width: 100%; height: 100%; display: flex; flex-direction: column;">
        <header>
            <div class="team-name" id="display-team-name">ƒê·ªòI THI: ???</div>
            <button id="btn-submit" onclick="submitGame()">N·ªòP B√ÄI (K·∫æT TH√öC)</button>
            <div class="hud">
                <div class="timer-box">‚è≥ <span id="timer">04:00</span></div>
            </div>
        </header>

        <div id="game-container">
            <div id="play-area"></div>
            <div id="bins-area">
                <div class="bin-zone">
                    <div class="bin-storage" id="bin-organic" data-type="organic"></div>
                    <div class="bin-header bg-organic">üçè R√ÅC TH·ª∞C PH·∫®M</div>
                </div>
                <div class="bin-zone">
                    <div class="bin-storage" id="bin-recycle" data-type="recycle"></div>
                    <div class="bin-header bg-recycle">‚ôªÔ∏è R√ÅC T√ÅI CH·∫æ</div>
                </div>
                <div class="bin-zone">
                    <div class="bin-storage" id="bin-other" data-type="other"></div>
                    <div class="bin-header bg-other">üóëÔ∏è R√ÅC C√íN L·∫†I</div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-result" class="full-screen hidden" style="background: rgba(0,0,0,0.85); backdrop-filter: blur(15px);">
        <h1 style="color: white; text-shadow: 0 0 10px var(--warning);">üéâ K·∫æT QU·∫¢ üéâ</h1>
        <div style="background: white; padding: 30px; border-radius: 30px; text-align: center; color: black; box-shadow: 0 0 50px rgba(255,255,255,0.5); border: 5px solid var(--warning); width: 500px; max-width: 90%;">
            <h2 id="res-team" style="color: var(--primary); font-size: 1.5rem;">ƒê·ªôi: ABC</h2>
            <h1 id="res-score" style="font-size: 5rem; margin: 10px 0; color: var(--danger); font-weight: 900;">45/100</h1>
            <p id="res-msg" style="font-size: 1.2rem; font-weight: bold; color: var(--success); margin-bottom: 5px;">C·ªë g·∫Øng l√™n nh√©!</p>
            
            <div id="review-box"></div>

            <button class="btn-large" style="margin-top: 20px;" onclick="saveAndExit()">L∆ØU K·∫æT QU·∫¢</button>
        </div>
    </div>

    <script>
        // --- 1. SVG GENERATOR ---
        function createSVGIcon(emoji, bgColor) {
            const svg = `
            <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="45" fill="${bgColor}" stroke="#333" stroke-width="3"/>
                <text x="50" y="62" font-size="55" text-anchor="middle" font-family="Segoe UI Emoji, Arial">${emoji}</text>
            </svg>`;
            return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
        }

        // --- 2. C·∫¨P NH·∫¨T D·ªÆ LI·ªÜU R√ÅC (ƒê√É CH·ªàNH S·ª¨A & TH√äM M·ªöI) ---
        const trashDatabase = [
            // --- NH√ìM TH·ª∞C PH·∫®M (Xanh l√°) ---
            { name: "V·ªè chu·ªëi", type: "organic", icon: "üçå", color: "#d4edda" },
            { name: "X∆∞∆°ng c√°", type: "organic", icon: "üêü", color: "#d4edda" },
            { name: "Rau h√©o", type: "organic", icon: "ü•¨", color: "#d4edda" },
            { name: "C∆°m th·ª´a", type: "organic", icon: "üçö", color: "#d4edda" },
            { name: "V·ªè cam", type: "organic", icon: "üçä", color: "#d4edda" },
            { name: "B√°nh m√¨ c≈©", type: "organic", icon: "ü•ñ", color: "#d4edda" },
            { name: "X∆∞∆°ng g√†", type: "organic", icon: "üçó", color: "#d4edda" }, // M·ªõi
            { name: "ƒê·∫ßu t√¥m", type: "organic", icon: "ü¶ê", color: "#d4edda" }, // M·ªõi

            // --- NH√ìM T√ÅI CH·∫æ (Xanh d∆∞∆°ng) ---
            { name: "Chai nh·ª±a", type: "recycle", icon: "üçæ", color: "#cff4fc" },
            { name: "Lon n∆∞·ªõc", type: "recycle", icon: "ü•§", color: "#cff4fc" },
            { name: "Gi·∫•y b√°o", type: "recycle", icon: "üì∞", color: "#cff4fc" },
            { name: "H·ªôp c√°c-t√¥ng", type: "recycle", icon: "üì¶", color: "#cff4fc" },
            { name: "S√°ch c≈©", type: "recycle", icon: "üìö", color: "#cff4fc" },
            { name: "Lon ƒë·ªì h·ªôp", type: "recycle", icon: "ü•´", color: "#cff4fc" },
            { name: "Chai th·ªßy tinh", type: "recycle", icon: "üè∫", color: "#cff4fc" },
            { name: "Th√¨a inox", type: "recycle", icon: "ü•Ñ", color: "#cff4fc" },
            { name: "V·ªü h·ªçc sinh", type: "recycle", icon: "üìí", color: "#cff4fc" },
            { name: "Gh·∫ø nh·ª±a h·ªèng", type: "recycle", icon: "ü™ë", color: "#cff4fc" },
            { name: "H·ªôp s·ªØa gi·∫•y", type: "recycle", icon: "üßÉ", color: "#cff4fc" }, // M·ªõi (V·ªè h·ªôp s·ªØa sau khi l√†m s·∫°ch)
            { name: "Gi·∫•y v·ª•n", type: "recycle", icon: "üìÉ", color: "#cff4fc" }, // M·ªõi

            // --- NH√ìM C√íN L·∫†I (X√°m/Other) ---
            // ƒê√£ chuy·ªÉn V·ªè tr·ª©ng v√† B√£ tr√† xu·ªëng ƒë√¢y theo y√™u c·∫ßu
            { name: "V·ªè tr·ª©ng", type: "other", icon: "ü•ö", color: "#e2e3e5" }, 
            { name: "B√£ tr√†", type: "other", icon: "ü´ñ", color: "#e2e3e5" },
            { name: "Kh·∫©u trang", type: "other", icon: "üò∑", color: "#e2e3e5" },
            { name: "Ly s√†nh v·ª°", type: "other", icon: "üçµ", color: "#e2e3e5" },
            { name: "T√£ gi·∫•y", type: "other", icon: "üß∑", color: "#e2e3e5" },
            { name: "Gi·∫•y ƒÉn b·∫©n", type: "other", icon: "ü§ß", color: "#e2e3e5" },
            { name: "G√≥i k·∫πo", type: "other", icon: "üç¨", color: "#e2e3e5" },
            { name: "G√≥i snack", type: "other", icon: "üçü", color: "#e2e3e5" },
            { name: "B√∫t bi h·∫øt m·ª±c", type: "other", icon: "üñäÔ∏è", color: "#e2e3e5" },
            { name: "B·∫≠t l·ª≠a", type: "other", icon: "üî•", color: "#e2e3e5" },
            { name: "Ly gi·∫•y cafe", type: "other", icon: "ü•§", color: "#e2e3e5" }, 
            { name: "H·ªôp x·ªëp b·∫©n", type: "other", icon: "ü•°", color: "#e2e3e5" }, 
            { name: "·ªêng h√∫t", type: "other", icon: "üßÉ", color: "#e2e3e5" },
            { name: "Hoa t√†n", type: "other", icon: "ü•Ä", color: "#d4edda" },
            { name: "K·∫πo cao su", type: "other", icon: "ü´ß", color: "#e2e3e5" }, // M·ªõi
            { name: "TƒÉm tre", type: "other", icon: "ü•¢", color: "#e2e3e5" }, // M·ªõi
            { name: "B√¥ng t·∫©y trang", type: "other", icon: "‚òÅÔ∏è", color: "#e2e3e5" }, // M·ªõi
            { name: "V·ªè s·∫ßu ri√™ng", type: "other", icon: "üçà", color: "#d4edda" }, // M·ªõi
            { name: "B√£ c√† ph√™", type: "other", icon: "‚òï", color: "#d4edda" }, // M·ªõi
        ];

        // --- 3. HELPER FUNCTIONS ---
        function getTypeName(type) {
            if (type === 'organic') return 'R√°c th·ª±c ph·∫©m';
            if (type === 'recycle') return 'R√°c t√°i ch·∫ø';
            if (type === 'other') return 'R√°c c√≤n l·∫°i';
            return 'Ch∆∞a ph√¢n lo·∫°i';
        }

        // --- 4. GAME LOGIC ---
        let currentTeam = "";
        let gameTimer;
        let timeLeft = 240; 
        let finalScore = 0;
        let isPlaying = false;

        function init() {
            if(!localStorage.getItem('greenSchoolData')) {
                localStorage.setItem('greenSchoolData', JSON.stringify([]));
            }
        }
        init();

        function goToGame() {
            const nameInput = document.getElementById('inp-team-name');
            if (nameInput.value.trim() === "") {
                alert("Vui l√≤ng nh·∫≠p t√™n ƒê∆°n v·ªã!");
                return;
            }
            currentTeam = nameInput.value.trim();
            document.getElementById('display-team-name').innerText = "ƒê·ªòI THI: " + currentTeam;
            
            document.getElementById('screen-register').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');
            startGame();
        }

        function startGame() {
            timeLeft = 240;
            isPlaying = true;
            document.getElementById('btn-submit').disabled = false;
            document.getElementById('btn-submit').innerText = "N·ªòP B√ÄI (K·∫æT TH√öC)";
            updateTimerDisplay();

            document.getElementById('play-area').innerHTML = '';
            document.querySelectorAll('.bin-storage').forEach(b => b.innerHTML = '');

            // --- THAY ƒê·ªîI: TƒÉng s·ªë l∆∞·ª£ng r√°c l√™n 20 m√≥n ƒë·ªÉ ƒë·∫°t 100 ƒëi·ªÉm (20 * 5) ---
            spawnTrash(20);

            clearInterval(gameTimer);
            gameTimer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    submitGame();
                }
            }, 1000);
        }

        function spawnTrash(count) {
            const area = document.getElementById('play-area');
            const shuffled = [...trashDatabase].sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, count);

            selected.forEach((item, i) => {
                const el = document.createElement('div');
                el.classList.add('trash-card');
                el.id = 'trash-' + i;
                el.dataset.type = item.type;
                el.dataset.name = item.name;

                const img = document.createElement('img');
                img.src = createSVGIcon(item.icon, item.color);
                img.classList.add('trash-img');
                
                const lbl = document.createElement('div');
                lbl.classList.add('trash-label');
                lbl.innerText = item.name;

                el.appendChild(img);
                el.appendChild(lbl);

                const maxX = area.clientWidth - 110;
                const maxY = area.clientHeight - 110;
                el.style.left = Math.random() * maxX + 'px';
                el.style.top = Math.random() * maxY + 'px';

                setupDrag(el);
                area.appendChild(el);
            });
        }

        // --- X·ª¨ L√ù K√âO TH·∫¢ (DRAG) ---
        let activeItem = null;
        let startX, startY, startLeft, startTop;

        function setupDrag(el) {
            el.addEventListener('mousedown', dragStart);
            el.addEventListener('touchstart', dragStart, {passive: false});
        }

        function dragStart(e) {
            if (!isPlaying) return;
            if (e.type === 'touchstart') e.preventDefault();
            activeItem = this;
            if (activeItem.classList.contains('in-bin')) {
                activeItem.classList.remove('in-bin');
                activeItem.style.position = 'absolute';
                document.getElementById('play-area').appendChild(activeItem);
            }
            const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
            const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
            startX = clientX; startY = clientY;
            const rect = activeItem.getBoundingClientRect();
            const areaRect = document.getElementById('play-area').getBoundingClientRect();
            startLeft = rect.left - areaRect.left; startTop = rect.top - areaRect.top;
            activeItem.style.left = startLeft + 'px'; activeItem.style.top = startTop + 'px';
            document.addEventListener('mousemove', dragMove); document.addEventListener('mouseup', dragEnd);
            document.addEventListener('touchmove', dragMove, {passive: false}); document.addEventListener('touchend', dragEnd);
        }

        function dragMove(e) {
            if (!activeItem) return;
            if (e.type === 'touchmove') e.preventDefault();
            const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
            const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
            const dx = clientX - startX; const dy = clientY - startY;
            activeItem.style.left = (startLeft + dx) + 'px'; activeItem.style.top = (startTop + dy) + 'px';
            document.querySelectorAll('.bin-storage').forEach(bin => {
                const rect = bin.getBoundingClientRect();
                if (clientX >= rect.left && clientX <= rect.right && clientY >= rect.top && clientY <= rect.bottom) {
                    bin.classList.add('drag-over');
                } else { bin.classList.remove('drag-over'); }
            });
        }

        function dragEnd(e) {
            if (!activeItem) return;
            document.removeEventListener('mousemove', dragMove); document.removeEventListener('mouseup', dragEnd);
            document.removeEventListener('touchmove', dragMove); document.removeEventListener('touchend', dragEnd);
            const rect = activeItem.getBoundingClientRect();
            const center_x = rect.left + rect.width/2; const center_y = rect.top + rect.height/2;
            let droppedBin = null;
            document.querySelectorAll('.bin-storage').forEach(bin => {
                bin.classList.remove('drag-over');
                const bRect = bin.getBoundingClientRect();
                if (center_x >= bRect.left && center_x <= bRect.right && center_y >= bRect.top && center_y <= bRect.bottom) {
                    droppedBin = bin;
                }
            });
            if (droppedBin) {
                droppedBin.appendChild(activeItem);
                activeItem.classList.add('in-bin');
                activeItem.style.left = 'auto'; activeItem.style.top = 'auto';
                activeItem.dataset.choice = droppedBin.dataset.type;
            } else {
                const area = document.getElementById('play-area');
                let finalL = parseInt(activeItem.style.left); let finalT = parseInt(activeItem.style.top);
                if(finalL < 0) finalL = 0; if(finalT < 0) finalT = 0;
                if(finalL > area.clientWidth - 100) finalL = area.clientWidth - 100;
                if(finalT > area.clientHeight - 100) finalT = area.clientHeight - 100;
                activeItem.style.left = finalL + 'px'; activeItem.style.top = finalT + 'px';
                activeItem.dataset.choice = "";
            }
            activeItem = null;
        }

        function updateTimerDisplay() {
            const m = Math.floor(timeLeft / 60); const s = timeLeft % 60;
            document.getElementById('timer').innerText = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
        }

        // --- 5. T√çNH ƒêI·ªÇM V√Ä XEM K·∫æT QU·∫¢ CHI TI·∫æT ---
        function submitGame() {
            if (!isPlaying) return;
            isPlaying = false;
            clearInterval(gameTimer);
            document.getElementById('btn-submit').disabled = true;

            finalScore = 0;
            const allItems = document.querySelectorAll('.trash-card');
            let correctCount = 0;
            const totalItems = allItems.length;
            
            let reviewHTML = "";
            let mistakeCount = 0;

            allItems.forEach(item => {
                const correctType = item.dataset.type;
                const userChoice = item.dataset.choice || ""; 
                const itemName = item.dataset.name;

                if (userChoice === correctType) {
                    finalScore += 5; // 5 ƒëi·ªÉm/c√¢u
                    correctCount++;
                    item.style.border = "4px solid #198754";
                } else {
                    item.style.border = "4px solid #dc3545";
                    mistakeCount++;
                    const userChoiceText = userChoice ? getTypeName(userChoice) : "Ch∆∞a b·ªè th√πng";
                    const correctText = getTypeName(correctType);
                    
                    reviewHTML += `
                    <div class="mistake-item">
                        <div>‚ùå <b>${itemName}</b></div>
                        <div style="font-size: 0.9rem;">
                            B·∫°n ch·ªçn: <span class="ans-wrong">${userChoiceText}</span> <br>
                            ƒê√∫ng l√†: <span class="ans-right">${correctText}</span>
                        </div>
                    </div>`;
                }
            });

            if (mistakeCount === 0) {
                reviewHTML = "<p style='color:green; font-weight:bold;'>Xu·∫•t s·∫Øc! B·∫°n kh√¥ng sai c√¢u n√†o.</p>";
            }

            setTimeout(() => {
                document.getElementById('res-team').innerText = "ƒê∆°n v·ªã: " + currentTeam;
                document.getElementById('res-score').innerText = finalScore + " ƒëi·ªÉm"; // S·∫Ω hi·ªÉn th·ªã t·ªëi ƒëa 100
                
                let msg = "";
                if (finalScore == totalItems * 5) msg = "Tuy·ªát ƒë·ªëi! Xu·∫•t s·∫Øc!";
                else if (finalScore >= (totalItems * 5) * 0.8) msg = "R·∫•t t·ªët! Ki·∫øn th·ª©c v·ªØng v√†ng!";
                else msg = "H√£y xem l·∫°i c√°c c√¢u sai b√™n d∆∞·ªõi nh√©!";
                
                document.getElementById('res-msg').innerText = `${msg} (ƒê√∫ng ${correctCount}/${totalItems} c√¢u)`;
                document.getElementById('review-box').innerHTML = reviewHTML;
                document.getElementById('screen-result').classList.remove('hidden');
            }, 500);
        }

        function saveAndExit() {
            const data = JSON.parse(localStorage.getItem('greenSchoolData'));
            const newRecord = {
                team: currentTeam,
                score: finalScore,
                timeLeft: timeLeft, 
                timestamp: new Date().getTime()
            };
            data.push(newRecord);
            localStorage.setItem('greenSchoolData', JSON.stringify(data));
            location.reload();
        }

        // --- 6. B·∫¢NG X·∫æP H·∫†NG & XU·∫§T FILE ---
        function showLeaderboard() {
            document.getElementById('screen-register').classList.add('hidden');
            document.getElementById('screen-leaderboard').classList.remove('hidden');
            
            const tbody = document.querySelector('#tbl-leaderboard tbody');
            tbody.innerHTML = "";
            const data = JSON.parse(localStorage.getItem('greenSchoolData'));
            
            data.sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return b.timeLeft - a.timeLeft;
            });

            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                const m = Math.floor(row.timeLeft / 60);
                const s = row.timeLeft % 60;
                const timeStr = `${m}:${s < 10 ? '0'+s : s}`;
                
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td style="text-align:left; padding-left:20px; font-weight: 500;">${row.team}</td>
                    <td style="font-weight:900; color: var(--primary); font-size: 1.3rem;">${row.score}</td>
                    <td>${timeStr}</td>
                `;
                tbody.appendChild(tr);
            });

            if (data.length === 0) {
                tbody.innerHTML = "<tr><td colspan='4' style='padding: 30px; color: #6c757d;'>Ch∆∞a c√≥ d·ªØ li·ªáu thi ƒë·∫•u</td></tr>";
            }
        }

        function exportExcel() {
            const data = JSON.parse(localStorage.getItem('greenSchoolData'));
            if (!data || data.length === 0) {
                alert("Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!");
                return;
            }
            data.sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return b.timeLeft - a.timeLeft;
            });
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += "H·∫°ng,T√™n ƒê∆°n V·ªã,ƒêi·ªÉm S·ªë,Th·ªùi Gian C√≤n L·∫°i (Gi√¢y),Ng√†y Thi\n";
            data.forEach((row, index) => {
                const date = new Date(row.timestamp).toLocaleString('vi-VN');
                const safeName = `"${row.team.replace(/"/g, '""')}"`; 
                csvContent += `${index + 1},${safeName},${row.score},${row.timeLeft},${date}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Ket_Qua_Hoi_Thi_Phan_Loai_Rac.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function backToRegister() {
            document.getElementById('screen-leaderboard').classList.add('hidden');
            document.getElementById('screen-register').classList.remove('hidden');
        }

        function clearData() {
            if(confirm("C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu kh√¥ng?\nH√£y ch·∫Øc ch·∫Øn b·∫°n ƒê√É XU·∫§T FILE EXCEL tr∆∞·ªõc khi x√≥a!")) {
                localStorage.removeItem('greenSchoolData');
                alert("ƒê√£ x√≥a d·ªØ li·ªáu!");
                showLeaderboard();
            }
        }
    </script>
</body>
</html>
